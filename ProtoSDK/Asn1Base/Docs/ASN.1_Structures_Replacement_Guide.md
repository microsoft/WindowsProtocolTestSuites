Introduction
============

This guide provides information about how to replace the original ASN.1 structures by the new ones. The original structures are generated by “ASN.1 Compiler” provided by Objective System. By importing the generated classes into Test Suites, along with the runtime “asn1rt.dll” provided by the same company, the ASN.1 structures defined in protocols can be handled by Test Suites properly and transmitted on the network. The architecture is as follow:

We would like to remove the dependency to the generated classes and runtime from Test Suites by replacing them.

Overview of our solution
========================

Here is the architecture of our solution:

It looks very similar to the original solution. The differences will be shown by introducing the procedure of the replacement.

Step 1. Determine target Test Suite and target structures
=========================================================

To start the replacement work, for the first step we need to find a set of ASN.1 structures in a target Test Suite, in which none of them depends on any structures that is not in the set. Furthermore, there shouldn’t be any structures that doesn’t belong to this set depends on any structures in the set.

To get such a set, we need to get all the ASN.1 definition for a SDK/Test Suite. Most of the definitions used in our Test Suites are listed as follows:

| **Module**       | **Link**                                                 |
|------------------|----------------------------------------------------------|
| Kerberos/Kile    | <https://msdn.microsoft.com/en-us/library/cc233875.aspx> |
| Kerberos/KKDCP   | <https://msdn.microsoft.com/en-us/library/hh553866.aspx> |
| Kerberos/Rfc3244 | <http://www.rfc-editor.org/rfc/rfc3244.txt> Page 2       |
| Kerberos/Rfc4120 | <http://www.rfc-editor.org/rfc/rfc4120.txt> Page 122     |
| Kerberos/Rfc6113 | <http://www.rfc-editor.org/rfc/rfc6113.txt> Page 45      |
| Kerberos/Spng    | <http://www.rfc-editor.org/rfc/rfc4178.txt> Page 15      |
| LDAP/AdtsLdapV3  | <http://www.rfc-editor.org/rfc/rfc4511.txt> Page 53      |
| LDAP/AdtsLdapV2  |                                                          |
| Rdpbcgr/T124     | <http://www.itu.int/rec/T-REC-T.124/en> Section 8.7      |
| Rdpbcgr/T125     | <http://www.itu.int/rec/T-REC-T.125/en> Section 7        |

Based on the observation, there are 6 such kind of sets. {Kile, KKDCP, Rfc3244, Rfc4120, Rfc6113}, {Spng}, {AdtsLdapV3}, {AdtsLdapV2}, {T124}, {T125}.

Step 2. Define the classes based on the ASN.1 definition
========================================================

Once we get the ASN.1 definitions, we could either manually define the C\# classes by referring to [ASN.1 Runtime User Guide](https://microsoft.sharepoint.com/teams/winteropsh/TestSuiteDevelopment/ASN.1Replacement/ASN.1%20Runtime%20User%20Guide.docx?d=w8f6897fd80ce42a9a9a8973dca61a826), or generate the classes by a simple tool (*Asn1Parser*). While defining/generating the classes, notice that:

1.  Some of the structures may not be found in the above table. We need to look for the ASN.1 definition in TD/MSDN/Internet, or manually define the classes based on the original classes generated by “ASN.1 Compiler”.

2.  The definition of some structures in the above table may be different from the original generated classes. Check [Missing Definitions](https://microsoft.sharepoint.com/teams/winteropsh/TestSuiteDevelopment/ASN.1Replacement/Missing%20Definitoins.xlsx?d=w2fce66164cc84ee69f9cb91752d3e6c0) for detail. Need to discuss with TS Owner about these issues.

3.  We manually modified some structures, e.g., KERB\_AD\_RESTRICTION\_ENTRY. Need to adopt the original modification in the new classes.

It would be better if we could do some tests on the newly defined/generated classes before we move to step 3. Ensure that the original ones and new ones have same encoding/decoding result.

**Estimated Effort. By using of the *Asn1Parser*, it will take no more than one day to generate all the structures in a module. It will take one or two days more if we encounter the issues mention above.**

Step 3. Replace in SDK
======================

By doing step 2, we could get all the newly defined/generated C\# classes. Follow the steps below to do the replacement in a SDK project:

1.  Copy the SDK to the same folder by “sd integrate”.

2.  Add the new C\# classes to the project and delete the original ones. Add the runtime project (*Asn1Base*) to the solution. Do not modify the original SDK since once it is changed, the Test Suites that depend on this SDK may not compile.

3.  Modify the other source files in the SDK since the interfaces of the new C\# classes and runtime are different. We mainly need to make 6 kind of changes. Listed as follow:

    1.  For Primitive Types like OCTET STRING, INTEGER, use **“Value”/”ByteArrayValue”** instead of **“mValue”** to get or set its data.

    2.  For SEQUENCE/SET OF, use **“Elements”** instead of **“elements”** to get or set its array form data.

    3.  For SEQUENCE/SET OF Types, use **“Asn1SequenceOf&lt;XXX&gt;”/”Asn1SetOf&lt;XXX&gt;”** instead of **“\_SeqOfXXX”/”\_SetOfXXX”**.

    4.  For the Encode and Decode Process, use **“Asn1BerEncodingBuffer”** instead of **“Asn1BerEncodeBuffer”**, **“Asn1DecodingBuffer”** instead of **“Asn1BerDecodeBuffer”**, and **“BerEncode(buffer)”** instead of **“Encode(buffer)”**.

    5.  To get the encoding result from an EncodingBuffer, use **“Data”** instead of **“MsgCopy”**.

    6.  The new classes provide less constructors than the original ones. Need to do the modifications accordingly when creating instances.

        Ensure that the SDK project could compile after doing these modifications.

The logic of the SDK should not be modified while replacing the structures.

**Estimated Effort. It will take about one day to modify the source code in the SDK so that it could compile with the newly generated classes and runtime.**

Step 4. Replace in the target Test Suite
========================================

After the new SDK could compile with the newly generated classes and runtime, we need to do some modifications in the target Test Suite. Follow the steps below:

1.  Replace the original SDK by the new one in the Solution of the target Test Suite.

2.  Add the new Runtime Project (*Asn1Base*) to the Solution and the Reference lists of the related projects.

3.  Modify the other source files in the Projects in the Solution. Make sure that the Solution could build successfully. Refer to Step 3 to see what kind of changes we need to make.

**Estimated Effort. It will take about one day to modify the source code in the Test Suite.**

Step 5. Build the msi and verify the new Test Suite
===================================================

Follow below steps to modify the “deploy” solution so that the new msi could build successfully:

1.  Install WiX 3.8 from the official site if it is not stalled.

2.  Open the VS solution “deploy.sln”.

3.  Replace the SDK in the solution.

4.  Add the new SDK project to the Reference list of “deploy” project. (Add from the “Project” tab in the promoted window)

5.  Modify “deploy.wixproj”: Replace &lt;Exec Command…&gt;. Two items (.csproj and PROTOSDK\_SRC\_XXX) will be different from the original text.

6.  Build by bcz in CoreXT in “…TestCode\\Deploy” folder to get the new wxs file for the SDK project.

7.  Replace the wxs file in “Deploy” project.

8.  In “TestSuiteProduct.wxs”, search “XXX.Sources” and “PROTOSDK\_SRC\_XXX” and do modifications accordingly.

9.  Add the new ASN.1 runtime project to “Directory” part in “TestSuiteProduct.wxs”.

Then build the msi for Test Suite and verify it.

**Estimated Effort. If the verification succeeds, it will take about one day to do this step. If the verification fails, we may need to debug and investigate the root cause. It may take one week or even more.**

Step 6. Check in
================

Check in the changes by three change list:

1.  Changes in Asn1Base.

2.  Changes in SDK.

3.  Changes in Test Suite.

Build again after they are submitted in case some files are missing.
